name: CMake

on:
  push:
    branches: [ cmake_refactoring, gh-action-cmake-checks ] #TODO point to master
  pull_request:
    branches: [ cmake_refactoring ]

jobs:
  clang:
    runs-on: ubuntu-latest
    container: mrtravis/gridtools:clang-${{ matrix.version }}
    strategy:
        matrix:
            version: [7, 8, 9]
            cuda-mode: [AUTO, Clang-CUDA, NVCC-CUDA]

    steps:
    - uses: actions/checkout@v2
    - name: CMake configure expect success
      if: contains(matrix.cuda-mode, 'AUTO')
      run: |
        mkdir build && cd build
        cmake .. -DGT_CLANG_CUDA_MODE=${{ matrix.cuda-mode }} > out.log
        grep "expect fail" out.log
    - name: CMake configure expect failure
      if: (!contains(matrix.cuda-mode, 'AUTO'))
      run: |
        mkdir build && cd build
        if cmake .. -DGT_CLANG_CUDA_MODE=${{ matrix.cuda-mode }}; then
            false
        else
            true
        fi
    #TODO parse CMake output and check if targets are available
