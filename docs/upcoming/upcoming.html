

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Upcoming Features &mdash; GridTools 0.20.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/cscs.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Glossary" href="../glossary/glossary.html" />
    <link rel="prev" title="User Manual" href="../user_manual/user_manual.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> GridTools
          

          
            
            <img src="../_static/logo.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                0.20
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../getting_started/getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user_manual/user_manual.html">User Manual</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Upcoming Features</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#user-specified-extents">User Specified Extents</a></li>
<li class="toctree-l2"><a class="reference internal" href="#design-of-grid-topology-for-irregular-grids">Design of Grid Topology for Irregular Grids</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#unstructured-mesh">Unstructured Mesh</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../glossary/glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../internal/internal.html">Internal Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq/faq.html">Frequently Asked Questions</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">GridTools</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>Upcoming Features</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/upcoming/upcoming.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="upcoming-features">
<span id="id1"></span><h1>Upcoming Features<a class="headerlink" href="#upcoming-features" title="Permalink to this headline">¶</a></h1>
<div class="section" id="user-specified-extents">
<h2>User Specified Extents<a class="headerlink" href="#user-specified-extents" title="Permalink to this headline">¶</a></h2>
<p>This is a feature to control compilation time in stencils with many
stages and many data fields. This is a feature likely used by higher
level approaches, since they may be already being doing data
dependence analysis and extent computation, so they can specified
those directly in the <cite>make_computation</cite> and save on C++ compilation
time.</p>
<p>A typical example of user code for making a <cite>multi_stage</cite> stencil is</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">auto</span> <span class="n">multi_stage</span> <span class="o">=</span> <span class="n">make_multistage</span><span class="p">(</span>
   <span class="n">execute</span><span class="o">&lt;</span><span class="n">forward</span><span class="o">&gt;</span><span class="p">(),</span>
   <span class="n">make_stage</span><span class="o">&lt;</span><span class="n">lap_operator</span><span class="o">&gt;</span><span class="p">(</span><span class="n">p_lap</span><span class="p">(),</span> <span class="n">p_in</span><span class="p">()),</span>
   <span class="n">make_stage</span><span class="o">&lt;</span><span class="n">flx_operator</span><span class="o">&gt;</span><span class="p">(</span><span class="n">p_flx</span><span class="p">(),</span> <span class="n">p_in</span><span class="p">(),</span> <span class="n">p_lap</span><span class="p">()),</span>
   <span class="n">make_stage</span><span class="o">&lt;</span><span class="n">fly_operator</span><span class="o">&gt;</span><span class="p">(</span><span class="n">p_fly</span><span class="p">(),</span> <span class="n">p_in</span><span class="p">(),</span> <span class="n">p_lap</span><span class="p">()),</span>
   <span class="n">make_stage</span><span class="o">&lt;</span><span class="n">out_operator</span><span class="o">&gt;</span><span class="p">(</span><span class="n">p_out</span><span class="p">(),</span> <span class="n">p_in</span><span class="p">(),</span> <span class="n">p_flx</span><span class="p">(),</span> <span class="n">p_fly</span><span class="p">())</span>
<span class="p">);</span>
</pre></div>
</div>
<p>The $GT$ stencil composition library will take the multi_stage type
and compute (at compile time) at what extents each stencil operator
should be computed to make the computation correct. This computation
is non trivial and may stress the compiler substantially if the
computation is made of many stages and uses many data fields (this is
not the case of the example shown above, which is rather small).</p>
<p>The user can then decide to tell explicitly the library to use certain
extents. To do so the use can used <cite>make_stage_with_extent</cite> for
__**all**__ the stages in the computation. The corresponding
syntax for the previous example would be:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">auto</span> <span class="n">multi_stage</span> <span class="o">=</span> <span class="n">make_multistage</span><span class="p">(</span>
   <span class="n">execute</span><span class="o">&lt;</span><span class="n">forward</span><span class="o">&gt;</span><span class="p">(),</span>
   <span class="n">make_stage_with_extent</span><span class="o">&lt;</span><span class="n">lap_operator</span><span class="p">,</span> <span class="n">extent</span><span class="o">&lt;-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="n">p_lap</span><span class="p">(),</span> <span class="n">p_in</span><span class="p">()),</span>
   <span class="n">make_stage_with_extent</span><span class="o">&lt;</span><span class="n">flx_operator</span><span class="p">,</span> <span class="n">extent</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="n">p_flx</span><span class="p">(),</span> <span class="n">p_in</span><span class="p">(),</span> <span class="n">p_lap</span><span class="p">()),</span>
   <span class="n">make_stage_with_extent</span><span class="o">&lt;</span><span class="n">fly_operator</span><span class="p">,</span> <span class="n">extent</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="n">p_fly</span><span class="p">(),</span> <span class="n">p_in</span><span class="p">(),</span> <span class="n">p_lap</span><span class="p">()),</span>
   <span class="n">make_stage_with_extent</span><span class="o">&lt;</span><span class="n">out_operator</span><span class="p">,</span> <span class="n">empty_extent</span><span class="o">&gt;</span><span class="p">(</span><span class="n">p_out</span><span class="p">(),</span> <span class="n">p_in</span><span class="p">(),</span> <span class="n">p_flx</span><span class="p">(),</span> <span class="n">p_fly</span><span class="p">())</span>
<span class="p">);</span>
</pre></div>
</div>
<p>When the library finds that all the stages specify extents the extent
analysis is skipped. If only some stages specify extents a compilation
error is triggered explaining the situation.</p>
<p>The downside of using this approach is that is the extents used bigger
than what they should be, the computation would be inefficient. If the
specified extents are too small, a run-time error will be raised with
an access violation. Indeed, protecting the user at compile time for
this scenario would force the extent analysis to be performed and this
is exactly what the user wanted to avoid in the first place.</p>
<p>The prototype implementation does a check to see if all the stages in
the MSS components array uses extents, if so the computation of the
extents is avoided and the extents extracted form the ESF descriptors
and put in the extent map.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">It would be very difficult to provide a default value for the
extent (for instance for the final stage), since the placeholders are
taken as variadic templates. It should be done by analysing the
variadic pack but it seems to me an over-sophistication.</p>
</div>
</div>
<div class="section" id="design-of-grid-topology-for-irregular-grids">
<h2>Design of Grid Topology for Irregular Grids<a class="headerlink" href="#design-of-grid-topology-for-irregular-grids" title="Permalink to this headline">¶</a></h2>
<p>The <cite>GridTopology</cite> concept provides:</p>
<ol class="arabic simple">
<li>Connectivity information to neighbours in the same and different <cite>LocationType</cite>’s.</li>
<li>Storage maker functionality</li>
</ol>
<p>The icosahedral <cite>grid</cite> class requires a class, as a template parameter, that implements a <cite>GridTopology</cite></p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">Axis</span><span class="p">,</span> <span class="k">typename</span> <span class="n">GridTopology</span><span class="o">&gt;</span>
<span class="k">struct</span> <span class="n">grid</span>
</pre></div>
</div>
<p>and can be constructed additionally with a runtime instance of the <cite>GridTopology</cite>, depending on whether
the concrete implementation of that <cite>GridTopology</cite> requires runtime connectivity information.</p>
<p>Currently there are two concrete implementations of the <cite>GridTopology</cite>:</p>
<p>1. The <cite>icosahedral_topology</cite> provides connectivity information at compile time, for icosahedral/octahedral grid layouts where all
the connectivity information can be derived at compiled time from the parallelogram structures based on simple stride rules.</p>
<p>An example of such structured index layout of the icosahedral grid parallelograms is shown in <a class="reference internal" href="#fig-ico-indices"><span class="std std-numref">Fig. 10</span></a>,
where the parallelogram can be indexed with three coordinates <cite>i</cite> and <cite>j</cite> and a color that identifies downward/upward triangles.
This particular data layout assumes an order in the dimensions like i-c-j (being <cite>i</cite> the stride - 1 dimension).
As an example, the cell with index 14, can be accessed with <cite>{i, c, j}</cite> coordinates <cite>{2, 0, 1}</cite>.
A similar scheme of indexing for <cite>edges</cite>, and <cite>vertices</cite> is developed.
All neighbour indexes of any cell/edge/vertex as well as connectivity to different <cite>LocationType</cite> can be express with simple
offset rules.</p>
<p>For example, the neighbor indices of any cell can be computed with the following rules:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="p">{{</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">c</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">},</span> <span class="p">{</span><span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">}}</span> <span class="k">for</span> <span class="n">downward</span> <span class="n">triangle</span> <span class="p">(</span><span class="n">color</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span>
<span class="p">{{</span><span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">},</span> <span class="p">{</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">c</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">},</span> <span class="p">{</span><span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">}}</span> <span class="k">for</span> <span class="n">upward</span> <span class="n">triangle</span>
</pre></div>
</div>
<p>Similar rules are derived for connectivities among different location types.</p>
<div class="figure" id="ico-indices">
<span id="fig-ico-indices"></span><a class="reference internal image-reference" href="../_images/ico_indices.png"><img alt="../_images/ico_indices.png" src="../_images/ico_indices.png" style="width: 588.8000000000001px; height: 341.40000000000003px;" /></a>
<p class="caption"><span class="caption-number">Fig. 10 </span><span class="caption-text">Structured index layout for icosahedral grid</span></p>
</div>
<p>Since all offset rules are based on the structured of the icosahedral parallelograms, and do not depend
on a particular runtime instance of the grid topology, they are derived at compile time.
These offsets rules can be extracted using the connectivity class API</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">SrcLocation</span><span class="p">,</span> <span class="k">typename</span> <span class="n">DestLocation</span><span class="p">,</span> <span class="n">uint_t</span> <span class="n">Color</span><span class="o">&gt;</span>
<span class="k">struct</span> <span class="n">connectivity</span>
</pre></div>
</div>
<p>For the icosahedral grid, the connectivity tables give access to the following 9 type of queries, depending on the <cite>from</cite> and <cite>to</cite> location types. See <a class="reference internal" href="#fig-location-type-opr"><span class="std std-numref">Fig. 11</span></a>.</p>
<div class="figure" id="id2">
<span id="fig-location-type-opr"></span><a class="reference internal image-reference" href="../_images/location_type_opr.png"><img alt="../_images/location_type_opr.png" src="../_images/location_type_opr.png" style="width: 654.6px; height: 467.4px;" /></a>
<p class="caption"><span class="caption-number">Fig. 11 </span><span class="caption-text">All possible connectivity queries in an icosahedral grid.</span></p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Depending on the location type, there are different number of neighbour indices. For example <cite>from&lt;cell&gt;::to&lt;edge&gt;</cite> will return a tuple of three
edge indices. The order of those neighbours, is part of the API and is defined based on physical meaning of PDE operators.</p>
</div>
<p>2. The <cite>unstructured_mesh</cite> implements a <cite>GridTopology</cite> for grid layouts without a clear structure, and therefore runtime lookup tables
need to be used in order to define connectivities between the different <cite>LocationTypes</cite>.</p>
<p>Since the connectivity information is stored as lookup tables, the <cite>unstructured_mesh</cite> needs to accept in the ctr an Atlas mesh object,
that contains all the necessary lookup tables.
All 9 lookup tables are then stored in two type of (atlas data structure) tables: MultiBlockConnectivity and IrregularConnectivity.
The main difference is that the connectivity described with a MultiBlockConnectivity shows a uniform number of neighbours for each entry in the table,
while in the IrregularConnectivity, each entry can have a different number of neighbours.</p>
<div class="section" id="unstructured-mesh">
<h3>Unstructured Mesh<a class="headerlink" href="#unstructured-mesh" title="Permalink to this headline">¶</a></h3>
<p>The <cite>grid</cite> concept has a <cite>GridTopology</cite> type, that can be of two classes (as described above).
Additionally for the types of <cite>GridTopology</cite> that require a runtime information with the connectivity tables,
the <cite>grid</cite> also has an <cite>unstructured mesh</cite> instance of type</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">using</span> <span class="n">unstructured_mesh_t</span> <span class="o">=</span>
  <span class="k">typename</span> <span class="n">boost</span><span class="o">::</span><span class="n">mpl</span><span class="o">::</span><span class="n">if_c</span><span class="o">&lt;</span><span class="n">is_unstructured_mesh</span><span class="o">&lt;</span><span class="n">GridTopology</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">,</span> <span class="n">GridTopology</span><span class="p">,</span> <span class="n">empty</span><span class="o">&gt;::</span><span class="n">type</span><span class="p">;</span>
</pre></div>
</div>
<p>In case of having a <cite>GridTopology</cite> of <cite>icosahedral_topology</cite> the instance that gets instantiated is an empty class.</p>
<p>Later this <cite>unstructured_mesh</cite> will be passed to the <cite>iterate_domain</cite> that requires the connectivity information.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../glossary/glossary.html" class="btn btn-neutral float-right" title="Glossary" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../user_manual/user_manual.html" class="btn btn-neutral float-left" title="User Manual" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, ETH Zurich

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>